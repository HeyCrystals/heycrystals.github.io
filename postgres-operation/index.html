<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.40.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>postgresql 安装|重置密码|备份数据|导入数据 &middot; 八一菜刀</title>

  
  <link type="text/css" rel="stylesheet" href="https://xiaoymin.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://xiaoymin.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://xiaoymin.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://xiaoymin.github.io/css/hyde.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://xiaoymin.github.io/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://xiaoymin.github.io/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="八一菜刀" />

  
</head>

  <body class=" ">
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://xiaoymin.github.io/"><h1>八一菜刀</h1></a>
      <p class="lead">
       顺着生命的河流一起流淌,体会身边的每份感动和感悟. 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://xiaoymin.github.io/">主页</a> </li>
      <li><a href="https://xiaoymin.github.io/blogs/"> 博客列表 </a></li><li><a href="https://xiaoymin.github.io/opensource/"> 开源软件 </a></li><li><a href="https://xiaoymin.github.io/softnews/"> 软件资讯 </a></li><li><a href="https://xiaoymin.github.io/about/"> 关于作者 </a></li>
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>postgresql 安装|重置密码|备份数据|导入数据</h1>
  <span class="post-date">2018-05-31</span>
  

<h2 id="安装">安装</h2>

<p>本机在Centos 7环境下安装postgresql</p>

<p>使用如下图安装方式安装完成,<a href="https://www.postgresql.org/download/linux/redhat/">安装指南</a></p>

<p><img src="install.png" alt="" /></p>

<h2 id="重置密码">重置密码</h2>

<p>完成安装后,并不知道postgresql的密码，在服务器终端通过ps命令可以查到postgres的进程，如下：</p>

<pre><code class="language-shell">[root@ZABBIX-SERVER 9.5]# ps -ef|grep postgres
root     24737 24564  0 13:40 pts/1    00:00:00 su postgres
postgres 24738 24737  0 13:40 pts/1    00:00:00 bash
postgres 24902     1  0 13:43 pts/1    00:00:00 /usr/pgsql-9.5/bin/postgres -D /var/lib/pgsql/9.5/data
postgres 24903 24902  0 13:43 ?        00:00:00 postgres: logger process   
postgres 24905 24902  0 13:43 ?        00:00:00 postgres: checkpointer process   
postgres 24906 24902  0 13:43 ?        00:00:00 postgres: writer process   
postgres 24907 24902  0 13:43 ?        00:00:00 postgres: wal writer process   
postgres 24908 24902  0 13:43 ?        00:00:00 postgres: autovacuum launcher process   
postgres 24909 24902  0 13:43 ?        00:00:00 postgres: stats collector process   
root     26244 24816  0 13:50 pts/3    00:00:00 grep --color=auto postgres
[root@ZABBIX-SERVER 9.5]# 

</code></pre>

<p>通过ps命令,postgres默认安装路径在<code>/usr/pgsql-9.5/</code>目录下，配置文件在<code>/var/lib/pgsql/9.5/data</code>中，该目录也是数据库存储目录</p>

<p>编辑pg_hba.conf文件</p>

<pre><code class="language-shell">vim /var/lib/pgsql/9.5/data/pg_hda.conf
</code></pre>

<p>将原来所有方式修改为trust，如下：</p>

<pre><code class="language-shell"># &quot;local&quot; is for Unix domain socket connections only
local   all             all                                     md5
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
host    all             all             0.0.0.0/0               trust
# IPv6 local connections:
host    all             all             ::1/128                 trust

</code></pre>

<p>修改完成后重启</p>

<pre><code class="language-shell">su postgres
cd /usr/pgsql-9.5/bin
./pg_ctl restart -D /var/lib/pgsql/9.5/data
等待服务器进程关闭 .... 完成
服务器进程已经关闭
正在启动服务器进程
bash-4.2$ &lt; 2018-05-31 13:43:30.580 CST &gt;日志:  无法绑定 IPv6 套接字: 无法指定被请求的地址
&lt; 2018-05-31 13:43:30.580 CST &gt;提示:  是否有其它 postmaster 已经在端口 5432 上运行了? 如果没有, 请等待几秒钟后然后再重试.
&lt; 2018-05-31 13:43:30.601 CST &gt;日志:  日志输出重定向到日志收集进程
&lt; 2018-05-31 13:43:30.601 CST &gt;提示:  后续的日志输出将出现在目录 &quot;pg_log&quot;中.

</code></pre>

<p>重启完成后,使用postgres登录</p>

<pre><code class="language-shell">[root@ZABBIX-SERVER 9.5]# psql --username=postgres
用户 postgres 的口令：
psql (9.5.13)
输入 &quot;help&quot; 来获取帮助信息.
postgres=# ^C
</code></pre>

<p>在该会话中执行修改密码命令：</p>

<pre><code class="language-shell">ALTER USER postgres WITH PASSWORD '新密码'; 
</code></pre>

<p>操作完成的，执行：\q命令回车退出。 </p>

<p>最后,恢复pg_hba.conf设置为md5并重启服务</p>

<h2 id="重启数据库">重启数据库</h2>

<pre><code class="language-sql">./usr/pgsql-9.5/bin/pg_ctl restart -D /var/lib/pgsql/9.5/data
</code></pre>

<h2 id="创建数据库">创建数据库</h2>

<p>创建用户数据库，如testdb：</p>

<pre><code class="language-sql">postgres=# CREATE DATABASE testdb OWNER dbuser;
</code></pre>

<p>将testdb数据库的所有权限都赋予dbuser：</p>

<pre><code class="language-sql">postgres=# GRANT ALL PRIVILEGES ON DATABASE testdb TO dbuser;
</code></pre>

<h2 id="删除数据库">删除数据库</h2>

<p>例如删除testdb：</p>

<pre><code class="language-sql">postgres=# DROP DATABASE testdb;
</code></pre>

<h2 id="备份数据">备份数据</h2>

<p>使用如下命令：</p>

<pre><code class="language-shell">pg_dump -h 127.0.0.1 -U postgres databasename &gt; db_backup_date.sql
</code></pre>

<p>-h:目标主机</p>

<p>-U：用户名称</p>

<h2 id="导入数据库">导入数据库</h2>

<p>使用如下命令：</p>

<pre><code class="language-shell">psql -U postgres -d databasename -f back_db_conf0529.sql 
</code></pre>

<p>-U：用户名称</p>

<p>-d：数据库名称</p>

<p>-f：导入数据库文件</p>

<h2 id="相关操作">相关操作</h2>

<h3 id="查看数据库">查看数据库</h3>

<pre><code class="language-sql">postgres=# \l               //\加上字母l,相当于mysql的，mysql&gt; show databases;
                                         资料库列表
       名称        |  拥有者  | 字元编码 |  校对规则   |    Ctype    |       存取权限        
-------------------+----------+----------+-------------+-------------+-----------------------
 ots_am_bdp_conf   | postgres | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 | 
 ots_app_conf      | postgres | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 | 
 ots_business_test | postgres | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 | 
 postgres          | postgres | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 | 
 template0         | postgres | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 | =c/postgres          +
                   |          |          |             |             | postgres=CTc/postgres
 template1         | postgres | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 | =c/postgres          +
                   |          |          |             |             | postgres=CTc/postgres
(6 行记录)

postgres=# 
postgres=# select pg_database_size('ots_business_test');   //查看ots_business_test数据库的大小  
 pg_database_size 
------------------
        399552276
(1 行记录)

postgres=# select pg_database.datname, pg_database_size(pg_database.datname) AS size from pg_database;  //查看所有数据库的大小  
      datname      |   size    
-------------------+-----------
 template1         |   6865412
 template0         |   6857220
 postgres          |   7089940
 ots_business_test | 399552276
 ots_am_bdp_conf   |  12939028
 ots_app_conf      |   8359700
(6 行记录)

postgres=# select pg_size_pretty(pg_database_size('ots_app_conf'));   //以KB，MB，GB的方式来查看数据库大小  
 pg_size_pretty 
----------------
 8164 kB
(1 行记录)

</code></pre>

<h3 id="查看多表">查看多表</h3>

<pre><code class="language-mssql">postgres=# select * from pg_tables;  //查询所有的表,相当于mysql的show tables;
     schemaname     |        tablename        | tableowner | tablespace | hasindexes | hasrules | hastriggers 
--------------------+-------------------------+------------+------------+------------+----------+-------------
 pg_catalog         | pg_statistic            | postgres   |            | t          | f        | f
 pg_catalog         | pg_cast                 | postgres   |            | t          | f        | f
 pg_catalog         | pg_authid               | postgres   | pg_global  | t          | f        | f
 //more...

postgres=# \d pg_cast;   //相当于mysql的，mysql&gt; desc pg_cast;  
  资料表 &quot;pg_catalog.pg_cast&quot;
    栏位     |  型别  | 修饰词 
-------------+--------+--------
 castsource  | oid    | 非空
 casttarget  | oid    | 非空
 castfunc    | oid    | 非空
 castcontext | &quot;char&quot; | 非空
 castmethod  | &quot;char&quot; | 非空
索引：
    &quot;pg_cast_oid_index&quot; UNIQUE, btree (oid)
    &quot;pg_cast_source_target_index&quot; UNIQUE, btree (castsource, casttarget)

postgres=# select pg_relation_size('pg_cast');    //查看表大小  
 pg_relation_size 
------------------
            16384
(1 行记录)
postgres=# select pg_size_pretty(pg_relation_size('pg_cast'));   //以KB，MB，GB的方式来查看表大小  
 pg_size_pretty 
----------------
 16 kB
(1 行记录)

postgres=# select pg_size_pretty(pg_total_relation_size('pg_cast'));  //查看表的总大小，包括索引大小 
 pg_size_pretty 
----------------
 80 kB
(1 行记录)



</code></pre>

<h3 id="查看索引">查看索引</h3>

<pre><code class="language-sql">postgres=&gt; \di                      //相当于mysql的，mysql&gt; show index from test;  
                List of relations  
 Schema |     Name      | Type  |  Owner  | Table  
--------+---------------+-------+---------+-------  
 public | playboy_id_pk | index | playboy | test  
(1 row)  
  
postgres=&gt; select pg_size_pretty(pg_relation_size('playboy_id_pk'));    //查看索大小  
 pg_size_pretty  
----------------  
 8192 bytes  
(1 row)  
</code></pre>

<h3 id="查看表空间-以及大小">查看表空间，以及大小</h3>

<pre><code class="language-sql">postgres=&gt; select spcname from pg_tablespace;         //查看所有表空间  
  spcname  
------------  
 pg_default  
 pg_global  
(2 rows)  
  
postgres=&gt; select pg_size_pretty(pg_tablespace_size('pg_default'));   //查看表空间大小  
 pg_size_pretty  
----------------  
 14 MB  
(1 row)  
</code></pre>

</div>


    </div>

    
  </body>
</html>