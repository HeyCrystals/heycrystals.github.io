<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" >
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <meta name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover">

  

  

  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="mybatis 源码系列(五) 数据源DataSource" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="mybatis 源码系列" />
<meta property="og:description" content="mybatis 源码系列" />
<link rel="canonical" href="/posts/mybatis-5/" />
<meta property="og:url" content="/posts/mybatis-5/" />
<meta property="og:site_name" content="八一菜刀" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-16T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="mybatis 源码系列(五) 数据源DataSource" />
<meta name="twitter:site" content="@xiaoymin" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-10-14T16:49:52+08:00","datePublished":"2019-05-16T00:00:00+08:00","description":"mybatis 源码系列","headline":"mybatis 源码系列(五) 数据源DataSource","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/mybatis-5/"},"url":"/posts/mybatis-5/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>mybatis 源码系列(五) 数据源DataSource | 八一菜刀
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="八一菜刀">
<meta name="application-name" content="八一菜刀">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
  
  <link rel="preconnect" href="https://fonts.googleapis.com" >
  <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
  
  <link rel="preconnect" href="https://fonts.googleapis.com" >
  <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
  
  <link rel="preconnect" href="https://cdn.jsdelivr.net" >
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  
  <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }
          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();
      });
    } /* constructor() */

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get isLightMode() {
      return this.mode === ModeToggle.LIGHT_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }
        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }
      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    } /* flipMode() */
  } /* ModeToggle */

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

</head>

  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/images/common/avatar.jpeg" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">八一菜刀</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Speak less,Do more</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>分类</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>标签</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
        <a
          href="https://github.com/xiaoymin"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/xiaoymin"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['xiaoymin','foxmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                首页
              </a>
            </span>

          
        
          
        
          
            
              <span>mybatis 源码系列(五) 数据源DataSource</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>mybatis 源码系列(五) 数据源DataSource</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1557936000"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2019/05/16
</time>

      </span>

      <!-- lastmod date -->
      
      <span>
        更新于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1697273392"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2023/10/14
</time>

      </span>
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
            
            <a href="https://twitter.com/xiaoymin">xiaoymin</a>
            

          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3979 字"
>
  <em>22 分钟</em>阅读</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>在第四章节中,我们分析里数据库驱动Driver的加载方式,其中有提到mybatis的数据源，我们都知道,Java中的SQL规范<code class="language-plaintext highlighter-rouge">java.sql.DataSource</code>是一个接口,而我们在生产环境中一般都是基于数据库的连接池技术来获取数据库连接以操作数据库的.</p>

<p>通常为我们所知的主流数据源主要有：druid、c3p0、dbcp,HikariCP等等</p>

<p>这些都是帮助我们实现的在数据库连接池技术上非常好的技术中间件,我们只需要引入相关的Jar包即可引用</p>

<h2 id="类型"><span class="me-2">类型</span><a href="#类型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>而这一节我们主要研究mybatis给我们提供的默认数据源</p>

<p>mybatis中的数据源主要位于<code class="language-plaintext highlighter-rouge">org.apache.ibatis.datasource</code>包下,主要有三种</p>

<ul>
  <li><strong>UnpooledDataSource</strong>：非数据库连接池的数据源,每次获取数据库Connection对象都会创建,不会使用数据库连接池</li>
  <li><strong>PooledDataSource</strong>：数据库连接池数据源</li>
  <li><strong>JndiDataSource</strong>:通过容器获取数据源</li>
</ul>

<p>先来看整个类图关系</p>

<p><a href="/images/mybatis/DataSource.png" class="popup img-link  shimmer"><img src="/images/mybatis/DataSource.png" alt="" loading="lazy"></a></p>

<h2 id="数据源工厂"><span class="me-2">数据源工厂</span><a href="#数据源工厂" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>先来看mybatis中的数据源工厂父类,<code class="language-plaintext highlighter-rouge">DataSourceFactory.java</code></p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * @author Clinton Begin
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataSourceFactory</span> <span class="o">{</span>

  <span class="cm">/***
   * 设置数据源属性
   * @param props
   */</span>
  <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="nc">Properties</span> <span class="n">props</span><span class="o">);</span>

  <span class="cm">/***
   * 获取当前数据源实例
   * @return
   */</span>
  <span class="nc">DataSource</span> <span class="nf">getDataSource</span><span class="o">();</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>数据源工厂中主要提供了两个方法：</p>

<ul>
  <li>设置数据源属性</li>
  <li>获取数据源</li>
</ul>

<p>有此两个方法,我们来看它的具体实现</p>

<h3 id="unpooleddatasourcefactory"><span class="me-2">UnpooledDataSourceFactory</span><a href="#unpooleddatasourcefactory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>非数据库连接池的数据源工厂，<code class="language-plaintext highlighter-rouge">UnpooledDataSourceFactory.java</code></p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre>
<span class="cm">/**
 * @author Clinton Begin
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnpooledDataSourceFactory</span> <span class="kd">implements</span> <span class="nc">DataSourceFactory</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DRIVER_PROPERTY_PREFIX</span> <span class="o">=</span> <span class="s">"driver."</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DRIVER_PROPERTY_PREFIX_LENGTH</span> <span class="o">=</span> <span class="no">DRIVER_PROPERTY_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>

  <span class="cm">/****
   * 声明数据源
   */</span>
  <span class="kd">protected</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

  <span class="cm">/****
   * 构造函数
   */</span>
  <span class="kd">public</span> <span class="nf">UnpooledDataSourceFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnpooledDataSource</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="nc">Properties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Properties</span> <span class="n">driverProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
      <span class="c1">//通过反射,获取dataSource的元数据对象,此处dataSource目标是UnpooledDataSource</span>
      <span class="c1">//关于元数据对象,我们在后面章节研究,此处不做深究</span>
    <span class="nc">MetaObject</span> <span class="n">metaDataSource</span> <span class="o">=</span> <span class="nc">SystemMetaObject</span><span class="o">.</span><span class="na">forObject</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">key</span> <span class="o">:</span> <span class="n">properties</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">propertyName</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">key</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">propertyName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">DRIVER_PROPERTY_PREFIX</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
        <span class="n">driverProperties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">propertyName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="no">DRIVER_PROPERTY_PREFIX_LENGTH</span><span class="o">),</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">metaDataSource</span><span class="o">.</span><span class="na">hasSetter</span><span class="o">(</span><span class="n">propertyName</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">properties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">convertedValue</span> <span class="o">=</span> <span class="n">convertValue</span><span class="o">(</span><span class="n">metaDataSource</span><span class="o">,</span> <span class="n">propertyName</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="n">metaDataSource</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">propertyName</span><span class="o">,</span> <span class="n">convertedValue</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">DataSourceException</span><span class="o">(</span><span class="s">"Unknown DataSource property: "</span> <span class="o">+</span> <span class="n">propertyName</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">driverProperties</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">metaDataSource</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="s">"driverProperties"</span><span class="o">,</span> <span class="n">driverProperties</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">getDataSource</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
  <span class="o">}</span>
    <span class="c1">//other...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>从数据工厂的源码中我们看到,非数据库连接池的数据源最终返回的是<code class="language-plaintext highlighter-rouge">UnpooledDataSource</code></p>

<p>setProperties方法的主要逻辑：</p>

<ul>
  <li>声明驱动属性配置,从源配置中赋值驱动属性</li>
  <li>通过反射获取UnpooledDataSource的元数据对象,对齐属性进行赋值</li>
  <li>关于mybatis的元数据对象MetaObject我们不在这章深究,只需要知道这么回事即可,知道他的作用(动态根据Properties对象赋值目标对象UnpooledDataSource的属性)</li>
</ul>

<p>所以通过源码,我们在使用非绑定数据源的方式如下：</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">//创建数据源工厂</span>
<span class="nc">UnpooledDataSourceFactory</span> <span class="n">unpooledDataSourceFactory</span><span class="o">=</span><span class="k">new</span> <span class="nc">UnpooledDataSourceFactory</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">driver</span><span class="o">=</span><span class="s">"com.mysql.cj.jdbc.Driver"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">url</span><span class="o">=</span><span class="s">"jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">username</span><span class="o">=</span><span class="s">"root"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">password</span><span class="o">=</span><span class="s">"123456"</span><span class="o">;</span>
<span class="c1">//赋值properties</span>
<span class="nc">Properties</span> <span class="n">properties</span><span class="o">=</span><span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"driver"</span><span class="o">,</span><span class="n">driver</span><span class="o">);</span>
<span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span><span class="n">url</span><span class="o">);</span>
<span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
<span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span><span class="n">password</span><span class="o">);</span>
<span class="n">unpooledDataSourceFactory</span><span class="o">.</span><span class="na">setProperties</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
<span class="c1">//如果使用的是UnpooledDataSource数据源,则以上properties属性赋值需要使用UnpooledDataSource的属性值</span>
<span class="c1">//获取数据源</span>
<span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">=</span><span class="n">unpooledDataSourceFactory</span><span class="o">.</span><span class="na">getDataSource</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></div></div>

<p>通过以上代码的方式,我们就能拿到DataSource的实例,从而获取数据库连接Connection对象</p>

<h4 id="unpooleddatasource"><span class="me-2">UnpooledDataSource</span><a href="#unpooleddatasource" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>此时,我们来看<code class="language-plaintext highlighter-rouge">UnpooledDataSource</code>的具体实现</p>

<p><code class="language-plaintext highlighter-rouge">UnpooledDataSource</code>主要包含的属性</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>属性</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>driverClassLoader</td>
      <td>当前驱动类的ClassLoader实例</td>
    </tr>
    <tr>
      <td>driverProperties</td>
      <td>驱动类的属性</td>
    </tr>
    <tr>
      <td>registeredDrivers</td>
      <td>注册驱动类</td>
    </tr>
    <tr>
      <td>driver</td>
      <td>数据库驱动</td>
    </tr>
    <tr>
      <td>url</td>
      <td>数据库连接地址</td>
    </tr>
    <tr>
      <td>username</td>
      <td>用户名</td>
    </tr>
    <tr>
      <td>password</td>
      <td>密码</td>
    </tr>
    <tr>
      <td>autoCommit</td>
      <td>是否自动提交</td>
    </tr>
    <tr>
      <td>defaultTransactionIsolationLevel</td>
      <td>事务隔离级别</td>
    </tr>
  </tbody>
</table></div>

<p>非数据池的获取数据库连接方式很简单,代码如下：</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">doGetConnection</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
<span class="o">}</span>
<span class="cm">/***
   * 获取数据连接对象
   * @param properties
   * @return
   * @throws SQLException
   */</span>
<span class="kd">private</span> <span class="nc">Connection</span> <span class="nf">doGetConnection</span><span class="o">(</span><span class="nc">Properties</span> <span class="n">properties</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="c1">//初始化Driver驱动</span>
    <span class="n">initializeDriver</span><span class="o">();</span>
    <span class="c1">//获取连接</span>
    <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
    <span class="c1">//配置连接属性,主要是是否自动提交和事务隔离级别</span>
    <span class="n">configureConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
<span class="o">}</span>
<span class="cm">/****
   * 配置Connection连接对象的属性
   * @param conn
   * @throws SQLException
   */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureConnection</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="c1">//是否自动提交</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">autoCommit</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">autoCommit</span> <span class="o">!=</span> <span class="n">conn</span><span class="o">.</span><span class="na">getAutoCommit</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="n">autoCommit</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//设置事务级别</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">defaultTransactionIsolationLevel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">conn</span><span class="o">.</span><span class="na">setTransactionIsolation</span><span class="o">(</span><span class="n">defaultTransactionIsolationLevel</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>获取数据库连接<code class="language-plaintext highlighter-rouge">Connection</code>对象的方式是每次都通过<code class="language-plaintext highlighter-rouge">DriverManager</code>来获取连接,不做连接池、缓存等处理.</p>

<h3 id="pooleddatasourcefactory"><span class="me-2">PooledDataSourceFactory</span><a href="#pooleddatasourcefactory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>通过上面的程序类图,我们其实已经知道,PooledDataSourceFactory其实是继承自UnPooledDataSourceFactory</p>

<p>来看代码：</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PooledDataSourceFactory</span> <span class="kd">extends</span> <span class="nc">UnpooledDataSourceFactory</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">PooledDataSourceFactory</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">//dataSource数据源此处为PooledDataSource</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PooledDataSource</span><span class="o">();</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="pooleddatasource"><span class="me-2">PooledDataSource</span><a href="#pooleddatasource" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<h5 id="源码"><span class="me-2">源码</span><a href="#源码" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>来看使用连接池的数据源</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre>
<span class="cm">/**
 * 这是一个简单，同步，线程安全的数据库连接池。
 *
 * @author Clinton Begin
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PooledDataSource</span> <span class="kd">implements</span> <span class="nc">DataSource</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Log</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="nc">PooledDataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="cm">/***
   * 连接池状态
   */</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PoolState</span> <span class="n">state</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PoolState</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UnpooledDataSource</span> <span class="n">dataSource</span><span class="o">;</span>

  <span class="c1">// OPTIONAL CONFIGURATION FIELDS</span>
  <span class="cm">/***
   * 连接池活动最大连接数
   */</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">poolMaximumActiveConnections</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
  <span class="cm">/***
   * 连接池最大空闲连接数量
   */</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">poolMaximumIdleConnections</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
  <span class="cm">/***
   * 最大checkout时间,默认20秒
   */</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">poolMaximumCheckoutTime</span> <span class="o">=</span> <span class="mi">20000</span><span class="o">;</span>
  <span class="cm">/***
   * 等待时间
   */</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">poolTimeToWait</span> <span class="o">=</span> <span class="mi">20000</span><span class="o">;</span>
  <span class="cm">/***
   * 连接池本地最大死的连接差值
   */</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">poolMaximumLocalBadConnectionTolerance</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
  <span class="kd">protected</span> <span class="nc">String</span> <span class="n">poolPingQuery</span> <span class="o">=</span> <span class="s">"NO PING QUERY SET"</span><span class="o">;</span>
  <span class="cm">/***
   * 是否启用ping操作
   */</span>
  <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">poolPingEnabled</span><span class="o">;</span>

  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">poolPingConnectionsNotUsedFor</span><span class="o">;</span>

  <span class="cm">/***
   * 连接执行类别代码
   */</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">expectedConnectionTypeCode</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PooledDataSource</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnpooledDataSource</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">PooledDataSource</span><span class="o">(</span><span class="nc">UnpooledDataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">;</span>
  <span class="o">}</span>
    <span class="c1">//other</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>从源码中我们看到：</p>

<ul>
  <li>连接池数据源中以UnPooledDataSource为基础,构造函数传入的也是非连接池数据源</li>
  <li>添加了连接池的相关基础属性,主要包含活动连接数、空闲连接数、等待时间等待</li>
</ul>

<p>来看连接池获取数据源的方式：</p>

<div class="language-java highlighter-rouge"><div class="code-header">
        <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
</pre></td><td class="rouge-code"><pre><span class="cm">/***
   * 获取数据库连接
   * @return
   * @throws SQLException
   */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Connection</span> <span class="nf">getConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">popConnection</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()).</span><span class="na">getProxyConnection</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/***
* 获取连接池的代理连接对象PooledConnection
*
*/</span>
<span class="kd">private</span> <span class="nc">PooledConnection</span> <span class="nf">popConnection</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">countedWait</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">PooledConnection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">localBadConnectionCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//空閑连接不为空</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">state</span><span class="o">.</span><span class="na">idleConnections</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="c1">// Pool has available connection</span>
          <span class="c1">//空空闲连接集合中获取一个连接,并移除空闲连接集合</span>
          <span class="n">conn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">idleConnections</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Checked out connection "</span> <span class="o">+</span> <span class="n">conn</span><span class="o">.</span><span class="na">getRealHashCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">" from pool."</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">//空闲连接集合数为空</span>
          <span class="c1">// Pool does not have available connection</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">activeConnections</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">poolMaximumActiveConnections</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//激活连接数小于最大活动连接数,则创建一个连接(从DataSource数据源中获取一个新的连接)</span>
            <span class="c1">// Can create new connection</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PooledConnection</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
              <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Created connection "</span> <span class="o">+</span> <span class="n">conn</span><span class="o">.</span><span class="na">getRealHashCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">//无法创建新的数据库连接</span>
            <span class="c1">// Cannot create new connection</span>
            <span class="nc">PooledConnection</span> <span class="n">oldestActiveConnection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">activeConnections</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">longestCheckoutTime</span> <span class="o">=</span> <span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">getCheckoutTime</span><span class="o">();</span>
            <span class="c1">//当前连接的检查时间大于连接池默认check时间</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">longestCheckoutTime</span> <span class="o">&gt;</span> <span class="n">poolMaximumCheckoutTime</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// Can claim overdue connection</span>
              <span class="c1">//当前连接为逾期连接</span>

              <span class="c1">//逾期连接数量+1</span>
              <span class="n">state</span><span class="o">.</span><span class="na">claimedOverdueConnectionCount</span><span class="o">++;</span>
              <span class="c1">//累计连接时间++</span>
              <span class="n">state</span><span class="o">.</span><span class="na">accumulatedCheckoutTimeOfOverdueConnections</span> <span class="o">+=</span> <span class="n">longestCheckoutTime</span><span class="o">;</span>
              <span class="c1">//累计check时间++</span>
              <span class="n">state</span><span class="o">.</span><span class="na">accumulatedCheckoutTime</span> <span class="o">+=</span> <span class="n">longestCheckoutTime</span><span class="o">;</span>
              <span class="c1">//把当前连接数从活动连接集合中移除</span>
              <span class="n">state</span><span class="o">.</span><span class="na">activeConnections</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">oldestActiveConnection</span><span class="o">);</span>
              <span class="c1">//判断是否非自动提交</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">getRealConnection</span><span class="o">().</span><span class="na">getAutoCommit</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                  <span class="c1">//如果当前数据库连接不是自动提交,则回滚事务</span>
                  <span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">getRealConnection</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                  <span class="cm">/*
                     Just log a message for debug and continue to execute the following
                     statement like nothing happend.
                     Wrap the bad connection with a new PooledConnection, this will help
                     to not intterupt current executing thread and give current thread a
                     chance to join the next competion for another valid/good database
                     connection. At the end of this loop, bad {@link @conn} will be set as null.
                   */</span>
                  <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bad connection. Could not roll back"</span><span class="o">);</span>
                <span class="o">}</span>  
              <span class="o">}</span>

              <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PooledConnection</span><span class="o">(</span><span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">getRealConnection</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
              <span class="n">conn</span><span class="o">.</span><span class="na">setCreatedTimestamp</span><span class="o">(</span><span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">getCreatedTimestamp</span><span class="o">());</span>
              <span class="n">conn</span><span class="o">.</span><span class="na">setLastUsedTimestamp</span><span class="o">(</span><span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">getLastUsedTimestamp</span><span class="o">());</span>
              <span class="c1">//老的连接置为不可用</span>
              <span class="n">oldestActiveConnection</span><span class="o">.</span><span class="na">invalidate</span><span class="o">();</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Claimed overdue connection "</span> <span class="o">+</span> <span class="n">conn</span><span class="o">.</span><span class="na">getRealHashCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span><span class="o">);</span>
              <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">//等待</span>
              <span class="c1">// Must wait</span>
              <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">countedWait</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">//等待数量+1</span>
                  <span class="n">state</span><span class="o">.</span><span class="na">hadToWaitCount</span><span class="o">++;</span>
                  <span class="c1">//等待标志位置为true</span>
                  <span class="n">countedWait</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                  <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Waiting as long as "</span> <span class="o">+</span> <span class="n">poolTimeToWait</span> <span class="o">+</span> <span class="s">" milliseconds for connection."</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="kt">long</span> <span class="n">wt</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                <span class="c1">//object的wait方法</span>
                <span class="n">state</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">poolTimeToWait</span><span class="o">);</span>
                <span class="c1">//累计等待时间</span>
                <span class="n">state</span><span class="o">.</span><span class="na">accumulatedWaitTime</span> <span class="o">+=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">wt</span><span class="o">;</span>
              <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// ping to server and check the connection is valid or not</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">conn</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">//当前PoolConnection对象连接可用</span>
            <span class="c1">//判断真实Connection是否自动提交,如果为false,则回滚当前事务.</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">conn</span><span class="o">.</span><span class="na">getRealConnection</span><span class="o">().</span><span class="na">getAutoCommit</span><span class="o">())</span> <span class="o">{</span>
              <span class="n">conn</span><span class="o">.</span><span class="na">getRealConnection</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">//设置当前连接hash</span>
            <span class="n">conn</span><span class="o">.</span><span class="na">setConnectionTypeCode</span><span class="o">(</span><span class="n">assembleConnectionTypeCode</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
            <span class="n">conn</span><span class="o">.</span><span class="na">setCheckoutTimestamp</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="n">conn</span><span class="o">.</span><span class="na">setLastUsedTimestamp</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="c1">//添加到活动连接集合中</span>
            <span class="n">state</span><span class="o">.</span><span class="na">activeConnections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
            <span class="c1">//请求数+1</span>
            <span class="n">state</span><span class="o">.</span><span class="na">requestCount</span><span class="o">++;</span>
            <span class="c1">//累计请求时间</span>
            <span class="n">state</span><span class="o">.</span><span class="na">accumulatedRequestTime</span> <span class="o">+=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
              <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"A bad connection ("</span> <span class="o">+</span> <span class="n">conn</span><span class="o">.</span><span class="na">getRealHashCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">") was returned from the pool, getting another connection."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">state</span><span class="o">.</span><span class="na">badConnectionCount</span><span class="o">++;</span>
            <span class="n">localBadConnectionCount</span><span class="o">++;</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">localBadConnectionCount</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">poolMaximumIdleConnections</span> <span class="o">+</span> <span class="n">poolMaximumLocalBadConnectionTolerance</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"PooledDataSource: Could not get a good connection to the database."</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">SQLException</span><span class="o">(</span><span class="s">"PooledDataSource: Could not get a good connection to the database."</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>

    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection."</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">SQLException</span><span class="o">(</span><span class="s">"PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h5 id="流程图"><span class="me-2">流程图</span><a href="#流程图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>通过获取此链接的方式,整理流程图如下：</p>

<p><a href="/images/mybatis/PooledDataSource.png" class="popup img-link  shimmer"><img src="/images/mybatis/PooledDataSource.png" alt="" loading="lazy"></a></p>

<h5 id="逻辑"><span class="me-2">逻辑</span><a href="#逻辑" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5>

<p>从上面获取连接对象的代码中,程序执行逻辑如下：</p>

<ul>
  <li>首先获取的代理数据库连接PooledConnection,该对象通过维护真是Connection,并通过JDK的动态代理产生真实的数据库Connection连接对象</li>
  <li>循环获取PooledConnection，知道获取得到为止</li>
  <li>首先拿到连接池状态锁，判断空闲连接池是否为空，如果不为空,获取第一个空闲连接(同时remove从空闲池集合中remove第一个),并返回</li>
  <li>如果空闲连接池为空,判断当前激活连接池大小是否小于连接池最大连接数,如果小于则new一个新的PooledConnection代理连接对象</li>
  <li>如果连接池最大连接数已满,获取第一个连接池代理对象,判断该代理对象是否预期(连接池预期时间默认20秒),如果当前连接已预期,从活动连接池中移除该连接,回滚当前连接事务，使用当前代理对象的Connection，作为创建新的PooledConnection对象的参数，老的连接置为不可用</li>
  <li>如果第一个池对象并未预期,则等待，根据连接池的等待时间进行等待</li>
  <li>拿到PooledConnection对象后,对当前连接判断是否有效,有效的方法验证主要包括当前连接是否关闭，如果只想query操作,并执行,执行拿到结果则当前连接为可用连接</li>
  <li>拿到真实Connection对象,判断是否自动提交,如果为false,则回滚当前Connection的事务，最后将该连接加入到连接池活动连接集合中返回</li>
  <li>当我们得到PooledConnection后，因为最终要返回的是Connection对象,随意调用池代理连接的getProxyConnect()方法获取代理对象</li>
  <li>获取代理对象时,首先判断当前Connection的方法，如果是调用close()方法,则首先会进入释放连接的逻辑，从当前活动连接池中移除该对象,判断空闲池空间足够,如果可用,加入空闲连接池,调用notifyAll(),唤醒wait线程,如果空闲连接池已满,则真实调用Connection的close()方法,并在之前回滚事务,关闭该连接</li>
</ul>

<h3 id="jndidatasourcefactory"><span class="me-2">JndiDataSourceFactory</span><a href="#jndidatasourcefactory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>关于Jndi数据源,工作中几乎没有用到过,印象中是通过J2EE容器来创建数据源,为此我还是特地搜索学习记录一下</p>

<p>首先,什么是JNDI？</p>

<blockquote>
  <p>JNDI(Java Naming and Directory Interface)是Java技术中指定的API，它为使用Java编程语言编写的应用程序提供命名和目录功能.它专为使用Java对象模型的Java平台而设计。使用JNDI，基于Java技术的应用程序可以存储和检索任何类型的命名Java对象,此外，JNDI还提供了执行标准目录操作的方法，例如将属性与对象相关联以及使用其属性搜索对象</p>

  <p>JNDI也是独立于任何特定命名或目录服务实现而定义的,它使应用程序能够使用通用API访问不同的，可能是多个命名和目录服务,可以在此通用API后面无缝插入不同的命名和目录服务提供程序。这使基于Java技术的应用程序能够利用各种现有命名和目录服务中的信息,例如LDAP，NDS，DNS和NIS（YP），以及使应用程序能够与传统软件和系统共存</p>

  <p>使用JNDI作为工具，您可以构建新的功能强大且可移植的应用程序，这些应用程序不仅可以利用Java的对象模型，而且还可以与部署它们的环境良好集成。</p>

  <p>通过在网络范围内共享有关用户，机器，网络，服务和应用程序的各种信息，JNDI在Intranet和Internet中发挥着至关重要的作用</p>
</blockquote>

<p>可以看<a href="https://www.oracle.com/technetwork/java/index-jsp-137536.html">官网解释</a>,我们知道Jndi是Java为我们提供的标准的Api,用于提供命名或目录服务</p>

<p>这就好比我们将我们的数据源写在外部的配置文件中同等道理,我们在Jndi配置了一个数据源,命名为<code class="language-plaintext highlighter-rouge">com/mybatis/prodDataSource</code>,而开发无需要知道该数据源地址，用户名密码等，甚至连接池也不用关心,只需要使用Jndi提供的api,就能初始化拿到数据源的Connection连接,进行数据库的操作。</p>

<p>这样做的好处：</p>

<ul>
  <li>开发在不同的环境(dev、prod)中可以使用相同的JNDI命名,这样在部署时,不用为了环境的不同,而变更相关的应用程序配置</li>
  <li>可以最小化需要知道访问生产数据库的凭据的人数。只有Java EE应用服务器需要知道您是否使用JNDI</li>
</ul>

<p>当然,随着Spring Boot应用框架给我们提供的各环境部署的策略,目前Jndi这些技术已经很少有人使用了.</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
    <div class="post-meta mb-3">
      <i class="far fa-folder-open fa-fw me-1"></i>
      
      <a href="/categories/mybatis/">mybatis</a>
    </div>
    

    <!-- tags -->
    

    <div class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      ">
      <div class="license-wrapper">
        
        

        本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted me-1">分享</span>
  <span class="share-icons">
    
    
    

    
      
      <a
        href="https://twitter.com/intent/tweet?text=mybatis%20%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97(%E4%BA%94)%20%E6%95%B0%E6%8D%AE%E6%BA%90DataSource%20-%20%E5%85%AB%E4%B8%80%E8%8F%9C%E5%88%80&url=%2Fposts%2Fmybatis-5%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    
      
      <a
        href="https://www.facebook.com/sharer/sharer.php?title=mybatis%20%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97(%E4%BA%94)%20%E6%95%B0%E6%8D%AE%E6%BA%90DataSource%20-%20%E5%85%AB%E4%B8%80%E8%8F%9C%E5%88%80&u=%2Fposts%2Fmybatis-5%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    
      
      <a
        href="https://t.me/share/url?url=%2Fposts%2Fmybatis-5%2F&text=mybatis%20%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97(%E4%BA%94)%20%E6%95%B0%E6%8D%AE%E6%BA%90DataSource%20-%20%E5%85%AB%E4%B8%80%E8%8F%9C%E5%88%80"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>

            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->

<div class="xiaoym-qrcode">
  <div class="xiaoym-qrcode-title">
    <h2>微信公众号(八一菜刀)</h2>
  </div>
  <div style="text-align: center;"><img src="/images/website/mp/qrcode.jpg" /> </div>
</div>














<section id="access-lastmod">
  <h2 class="panel-heading">最近更新</h2>
  <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
    
    
    
    
    <li class="text-truncate lh-lg">
      <a href="/posts/llm-start/">全面进击AI大模型、RAG领域</a>
    </li>
    
    
    
    
    <li class="text-truncate lh-lg">
      <a href="/posts/rag-inaction-java/">实战0-1,Java开发者也能看懂的大模型应用RAG开发实践</a>
    </li>
    
    
    
    
    <li class="text-truncate lh-lg">
      <a href="/posts/use-prompt-framework/">用好大模型?这5种实用的Prompt框架你一定要看看!</a>
    </li>
    
    
    
    
    <li class="text-truncate lh-lg">
      <a href="/posts/knife4j-insight-mvp/">Knife4jInsight平台版-MVP版本v1.0.0发布</a>
    </li>
    
    
    
    
    <li class="text-truncate lh-lg">
      <a href="/posts/spring-boot-conditional/">Spring Boot框架中如何优雅的注入实体Bean</a>
    </li>
    
  </ul>
</section>
<!-- #access-lastmod -->

              <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/llm/">LLM</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rag/">RAG</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rag%E5%AE%9E%E6%88%98/">RAG实战</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AE%9E%E6%88%98/">大模型实战</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/mybatis-toc/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1557417600"
  data-df="YYYY/MM/DD"
  
>
  2019/05/10
</time>

              <h4 class="pt-0 my-2">mybatis 源码系列</h4>
              <div class="text-muted">
                <p>
                  





                  最近闲来无事,之前在开发过程中一直在使用mybatis这个技术框架,但是一直没有认真的好好读一下mybatis的源码,所以,决定把mybatis的源码通读一遍,在对mybatis的基础使用上,巩固自己的技术积累,也想通过这个优秀的开源ORM框架中学到一些程序设计理念.并且通过博客记录的方式,加深自己的印象.

在这个浮躁的社会中,我们唯一能做到的就是做好自己。

mybatis版本号：3.5...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/mybatis-1/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1557504000"
  data-df="YYYY/MM/DD"
  
>
  2019/05/11
</time>

              <h4 class="pt-0 my-2">mybatis 源码系列(一) 初始化</h4>
              <div class="text-muted">
                <p>
                  





                  通过阅读mybatis的官方文档,我们知道了初始化mybatis的方法有以下两种方法:


  通过XML文件构建SqlSessionFactory对象,最终创建SqlSession使用对象实例
  通过Java创建Configuration对象来构建SqlSessionFactory对象


类图

我们先来看mybatis的初始化相关的几个基础类图



几个关键类说明：


  Sql...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/mybatis-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1557590400"
  data-df="YYYY/MM/DD"
  
>
  2019/05/12
</time>

              <h4 class="pt-0 my-2">mybatis 源码系列(二) 配置类Configuration</h4>
              <div class="text-muted">
                <p>
                  





                  我们在第一章初始化中知道了mybatis的核心配置类为org.apache.ibatis.session.Configuration.java

先来看Configuration.java的类图



看到类图,瞬间就懵逼了,这属性也太多了吧…..

不过想到mybatis的功能如此强大,那如此多的属性也是可以理解的，我会逐一探索.

构造函数

通过类图我们发现,Configuration...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/mybatis-4/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>mybatis 源码系列(四) 数据库驱动Driver加载方式</p>
    </a>
  

  
    <a
      href="/posts/mybatis-6/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>mybatis 源码系列(六) 设计模式</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  (function () {
    const origin = 'https://giscus.app';
    const iframe = 'iframe.giscus-frame';
    const lightTheme = 'light';
    const darkTheme = 'dark_dimmed';

    let initTheme = lightTheme;
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') &&
        html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'xiaoymin/xiaoymin.github.io',
      'data-repo-id': 'MDEwOlJlcG9zaXRvcnk3OTUzMjIxNw==',
      'data-category': 'Comments',
      'data-category-id': 'DIC_kwDOBL2Quc4CaKF6',
      'data-mapping': 'pathname',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'bottom',
      'data-lang': 'zh-CN',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.getElementById('tail-wrapper').appendChild(giscusScript);

    addEventListener('message', (event) => {
      if (
        event.source === window &&
        event.data &&
        event.data.direction === ModeToggle.ID
      ) {
        /* global theme mode changed */
        const mode = event.data.message;
        const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme;

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.querySelector(iframe).contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }
    });
  })();
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://twitter.com/xiaoymin">xiaoymin</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/llm/">LLM</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rag/">RAG</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rag%E5%AE%9E%E6%88%98/">RAG实战</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AE%9E%E6%88%98/">大模型实战</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/zh.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

